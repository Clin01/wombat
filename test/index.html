<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hi</title>
    <link href="../node_modules/mocha/mocha.css" rel="stylesheet"/>
    <style>
        #wombatSandboxContainer {
            display: none;
        }

        #wombatSandbox {
            display: none;
        }
    </style>
</head>
<body>
<div id="mocha"></div>
<div id="wombatSandboxContainer"></div>
<script src="../node_modules/mocha/mocha.js" type="text/javascript"></script>
<script src="../node_modules/chai/chai.js" type="text/javascript"></script>
<script src="../node_modules/chai-dom/chai-dom.js" type="text/javascript"></script>
<script>mocha.setup('bdd')</script>
<script src="test.env.js" type="text/javascript"></script>
<script type="module">
  import { chaiURL, chaiAsPromised } from './chaiUtils.js'

  chai.use(chaiURL)
  chai.use(chaiAsPromised)
  window.wombatTestUtil = {
    addedSandbox: false,
    isSandboxReady: false,
    /**
     * @return {Promise<HTMLIFrameElement>}
     */
    addWombatSandbox () {
      console.log('adding wombat sandbox')
      if (!this.addedSandbox) {
        const container = document.getElementById('wombatSandboxContainer')
        const wbif = document.createElement('iframe')
        wbif.src = 'wombatSandbox.html'
        wbif.id = 'wombatSandbox'
        container.appendChild(wbif)
        this.addedSandbox = true
        return new Promise((resolve) => {
          this.done = resolve
        })
      }
      return Promise.resolve(this.sandbox)
    },
    removeWombatSandbox () {
      if (this.addedSandbox) {
        this.sandbox = null
        document.getElementById('wombatSandbox').remove()
        this.addedSandbox = false
      }
    },
    sandboxReady () {
      if (this.sandbox == null) {
        console.log('sandbox ready')
        const sandboxIf = document.getElementById('wombatSandbox')
        this.sandbox = sandboxIf
        console.log(this.sandbox)
      }
      if (this.done) {
        this.done(this.sandbox)
        this.done = null
      }
    },
    refreshSandbox () {
      this.sandbox.location.refresh()
      return new Promise((resolve) => {
        this.done = resolve
      })
    }
  }
  window.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'wombat-sandbox-ready') {
      window.wombatTestUtil.sandboxReady()
    } else {
      console.log(event)
    }
  }, false)
  mocha.run()
</script>
</body>
</html>