<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hi</title>
    <link href="mocha.css" rel="stylesheet"/>
    <style>
        #wombatSandboxContainer {
            display: none;
        }

        #wombatSandbox {
            display: none;
        }
    </style>
</head>
<body>
<div id="mocha"></div>
<div id="wombatSandboxContainer"></div>
<script src="test-setup-bundle.js" type="text/javascript"></script>
<script>
  mocha.setup({
    ui: 'bdd',
    ignoreLeaks: true
  });

  function initTestContext (options = {init: false}) {
    return async function () {
      let wombatIf = await window.wombatTestUtil.addWombatSandbox();
      /**
       * @type {{window: Window | null, document: Document | null}}
       */
      this.wombatSandbox = {
        window: wombatIf.contentWindow,
        document: wombatIf.contentDocument
      };

      Object.defineProperty(this, 'wombatMSGs', {
        get () { return window.wombatTestUtil.wombatMSGs }
      });

      const testSelf = this
      this._$internalHelper = {
        validTestTitles: {
          '"before all" hook': true,
          '"before" hook': true
        },
        checkValidCall () {
          if (!this.validTestTitles[testSelf.test.title]) {
            console.log(this.validTestTitles, testSelf.test.title);
            throw new Error(`Invalid usage of internal helpers at ${testSelf.test.title}`);
          }
        },
        async refresh () {
          this.checkValidCall();
          wombatIf = await window.wombatTestUtil.refreshSandbox();
          testSelf.wombatSandbox.window = wombatIf.contentWindow;
          testSelf.wombatSandbox.document = wombatIf.contentDocument;
        },
        async refreshInit () {
          await this.refresh();
          this.init();
        },
        init () {
          testSelf.wombatSandbox.window._WBWombatInit.call(testSelf.wombatSandbox.window);
        }
      }
      if (options.init) {
        await this._$internalHelper.refreshInit();
      }
    };
  }
</script>
<script src="test.wombat-setup.js" type="text/javascript"></script>
<script src="test.wombat-exposed-functions.js" type="text/javascript"></script>
<script src="test.wombat-overrides.js" type="text/javascript"></script>
<script>
  mocha.run();
</script>
</body>
</html>